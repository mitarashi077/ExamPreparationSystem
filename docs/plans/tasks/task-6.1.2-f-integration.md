# タスク: ブックマーク機能 - API連携・統合テスト

計画書: Task 6.1.2 ブックマーク機能
全体設計書: task-6.1.2-decomposition.md (.tmp配置)
タスク番号: 6.1.2-F
タスクサイズ: 小規模
想定ファイル数: 4
想定作業時間: 20分
依存タスク: 全サブタスク（A,B,C,D,E）完了必須
並行実行: ❌ 統合フェーズのため単独実行
担当推奨エージェント: quality-fixer

## 全体における位置づけ
### プロジェクト全体の目的
ワンタップでブックマーク追加/削除、メモ機能付きブックマーク、カテゴリ別フィルタ・検索機能を備えた重要問題マーク機能の実装

### このタスクの役割
全サブタスクで実装された各コンポーネントをAPI連携により統合し、エンドツーエンドでの動作確認とエラーケーステストを実施する

### 前タスクとの関連
- 前タスク: 6.1.2-A（データベース）、6.1.2-B（ボタン）、6.1.2-C（状態管理）、6.1.2-D（API）、6.1.2-E（管理ページ）
- 引き継ぐ情報: 全コンポーネント、API仕様、状態管理ストア

### 後続タスクへの影響
- 後続タスク: Task 6.2.1 試験日程管理
- 提供する情報: 完成したブックマーク機能、統合テスト結果、品質保証済みのコード

## 概要
フロントエンドの状態管理ストアとバックエンドAPIを連携し、モック関数を実際のAPI通信に置き換える。全体的な動作確認とエラーハンドリングのテストを実施し、ブックマーク機能を完成させる。

## 対象ファイル
- [ ] frontend/src/stores/useBookmarkStore.ts（API連携に更新）
- [ ] frontend/src/components/BookmarkButton.tsx（ストア接続確認）
- [ ] frontend/src/pages/BookmarksPage.tsx（API連携確認）
- [ ] integration-tests/bookmark-feature.test.ts（新規作成）

## 実装手順（TDD: Red-Green-Refactor）

### 1. **Red Phase - 失敗するテストを書く**
   - [ ] フロントエンド-バックエンド統合テスト作成：
     - ブックマーク追加フロー（ボタンクリック → API呼び出し → 状態更新）
     - ブックマーク削除フロー（削除操作 → API呼び出し → 状態同期）
     - メモ編集フロー（モーダル → API更新 → 即座に反映）
   - [ ] エラーケーステスト作成（ネットワークエラー、認証エラー、バリデーションエラー）
   - [ ] テスト実行して失敗を確認：`npm test -- bookmark-feature.test.ts`

### 2. **Green Phase - 最小限の実装**
   - [ ] useBookmarkStoreのモック関数を実際のAPI通信に置き換え：
     ```typescript
     const addBookmark = async (questionId: number) => {
       try {
         const response = await fetch('/api/bookmarks', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ questionId })
         });
         if (response.ok) {
           const bookmark = await response.json();
           set(state => ({ bookmarks: [...state.bookmarks, bookmark] }));
         }
       } catch (error) {
         // エラーハンドリング
       }
     };
     ```
   - [ ] BookmarkButtonコンポーネントがストアと正しく連携することを確認
   - [ ] 追加したテストのみ実行して通ることを確認

### 3. **Refactor Phase - コード改善**
   - [ ] 包括的なエラーハンドリング実装（ユーザーフレンドリーなエラーメッセージ）
   - [ ] オプティミスティックアップデート実装（レスポンス向上）
   - [ ] リトライ機能の実装（ネットワークエラー対策）
   - [ ] ローディング状態の管理とUI反映
   - [ ] 追加したテストが引き続き通ることを確認

## 完了条件
- [ ] Red Phase: エンドツーエンド統合テストを作成済み
- [ ] Green Phase: 最小限のAPI連携実装でテストがパス
- [ ] Refactor Phase: エラーハンドリング・UX改善実装済み、追加したテストが通る状態を維持
- [ ] 追加した統合テストのみが全てパス（全体テストは品質保証工程で実施）
- [ ] **注記**: 全体品質保証とコミット作成は品質保証工程で別途実施

## 注意事項
### 実装上の注意
- 各サブタスクで実装されたコンポーネントのインターフェースを尊重し、破壊的変更を避けること
- API連携時のエラーハンドリングは一貫したパターンを使用すること
- オプティミスティックアップデートの実装時は、失敗時のロールバック処理を適切に行うこと
- ローディング状態の管理で既存の共通コンポーネント（スピナー等）を活用すること

### 影響範囲の制御
- このタスクで変更してはいけない部分: 各サブタスクで実装されたコンポーネントの基本構造
- 影響が波及する可能性がある箇所: 共通のエラーハンドリングパターン、API通信ライブラリの使用方法

### 共通化の指針
- 他タスクと共通化すべき処理: API通信の共通関数、エラーハンドリングパターン
- 冗長実装を避けるための確認事項: 既存のAPI通信パターンと統一性を保ち、再利用可能な関数を活用する