# タスク: ブックマーク機能 - バックエンドAPI実装

計画書: Task 6.1.2 ブックマーク機能
全体設計書: task-6.1.2-decomposition.md (.tmp配置)
タスク番号: 6.1.2-D
タスクサイズ: 小規模
想定ファイル数: 2
想定作業時間: 20分
依存タスク: 6.1.2-A（データベーススキーマ設計・実装）完了必須
並行実行: ✅ 6.1.2-E（ブックマーク管理ページ）と同時実行可能
担当推奨エージェント: backend-executor

## 全体における位置づけ
### プロジェクト全体の目的
ワンタップでブックマーク追加/削除、メモ機能付きブックマーク、カテゴリ別フィルタ・検索機能を備えた重要問題マーク機能の実装

### このタスクの役割
ブックマーク機能のCRUD API エンドポイントを実装し、フロントエンドとデータベース間の安全なデータ通信を提供する

### 前タスクとの関連
- 前タスク: 6.1.2-A（データベーススキーマ設計・実装）
- 引き継ぐ情報: Bookmarkモデル定義、データベーステーブル構造

### 後続タスクへの影響
- 後続タスク: 6.1.2-F（API連携・統合テスト）
- 提供する情報: REST API エンドポイント、レスポンス形式、エラーハンドリング仕様

## 概要
ブックマーク機能に必要なCRUD APIエンドポイントを実装する。GET（一覧取得）、POST（追加）、PUT（メモ更新）、DELETE（削除）の各操作に対応し、適切なバリデーションとエラーハンドリングを行う。

## 対象ファイル
- [ ] backend/src/controllers/bookmarkController.ts（新規作成）
- [ ] backend/src/index.ts（ルート追加）

## 実装手順（TDD: Red-Green-Refactor）

### 1. **Red Phase - 失敗するテストを書く**
   - [ ] CRUD APIエンドポイントの動作テスト作成：
     - `GET /api/bookmarks` - ブックマーク一覧取得
     - `POST /api/bookmarks` - ブックマーク追加
     - `PUT /api/bookmarks/:id` - メモ更新
     - `DELETE /api/bookmarks/:id` - ブックマーク削除
   - [ ] バリデーションエラーのテスト作成
   - [ ] 認証エラーのテスト作成
   - [ ] テスト実行して失敗を確認：`npm test -- bookmarkController.test.ts`

### 2. **Green Phase - 最小限の実装**
   - [ ] bookmarkControllerの基本実装：
     ```typescript
     export const getBookmarks = async (req: Request, res: Response) => {
       try {
         const { userId } = req.user;
         const bookmarks = await prisma.bookmark.findMany({
           where: { userId },
           include: { question: true }
         });
         res.json({ bookmarks });
       } catch (error) {
         res.status(500).json({ error: 'Failed to fetch bookmarks' });
       }
     };
     ```
   - [ ] 基本的なCRUDエンドポイント実装
   - [ ] index.tsにルート追加
   - [ ] 追加したテストのみ実行して通ることを確認

### 3. **Refactor Phase - コード改善**
   - [ ] 包括的なバリデーション実装（Joi/Zod使用）
   - [ ] 詳細なエラーハンドリング（適切なHTTPステータスコード）
   - [ ] クエリパラメータ対応（フィルタ、ソート、ページネーション）
   - [ ] レスポンス形式の統一（APIレスポンス標準化）
   - [ ] 追加したテストが引き続き通ることを確認

## 完了条件
- [ ] Red Phase: CRUD APIエンドポイントのテストを作成済み
- [ ] Green Phase: 最小限のAPI実装でテストがパス
- [ ] Refactor Phase: バリデーション・エラーハンドリング実装済み、追加したテストが通る状態を維持
- [ ] 追加したAPIエンドポイントテストのみが全てパス（全体テストは品質保証工程で実施）
- [ ] **注記**: 全体品質保証とコミット作成は品質保証工程で別途実施

## 注意事項
### 実装上の注意
- タスク6.1.2-Aで作成されたBookmarkモデルとPrismaスキーマを正確に参照すること
- ユーザー認証ミドルウェアを使用してユーザーIDを取得すること
- 重複ブックマーク追加の制御（ユニーク制約エラーのハンドリング）
- メモフィールドの適切なサニタイゼーション

### 影響範囲の制御
- このタスクで変更してはいけない部分: 既存の認証ミドルウェア、他のコントローラー
- 影響が波及する可能性がある箇所: APIレスポンス形式、エラーハンドリングパターン

### 共通化の指針
- 他タスクと共通化すべき処理: エラーハンドリング関数、バリデーション関数
- 冗長実装を避けるための確認事項: 既存コントローラーのパターンに準拠してコード統一性を保つ